# mgkahn/n6293_ui

## Purpose:
This is one of two docker images used for NURS 6293 Introduction to Database Systems at the University of Colorado Anschutz Medical Campus College of Nursing (https://catalog.ucdenver.edu/cu-anschutz/courses-a-z/nurs/)as part of its Masters level Nursing Informatics program. This docker image provides a Ubuntu front end running HTML-5 based NOVNC GUI access to DBMS tools that connect to a Firebird docker image (https://github.com/mgkahn/n6293_db). This image is multi-architecture for ARM64 and AARCH64 (runs on Apple Silicon Macs).

## Core Features:
- Dockerfile uses "builder" model based on mgkahn/ubuntu_22_04, which is a minimally altered clone of https://github.com/Frederic-Boulanger-UPS/docker-ubuntu_22-04-novnc.
- Creates new user based on $USER_NAME and $USER_ID from host so that files in shared folder have correct ownership.
  - Default user password = `nurs6293`
- Uses Docker-managed volume, named ui_vol, to persist configurations and files from ${HOME} directory.
- Desktop folder ("Transfer_Station") links to host Desktop folder with same name. Moves files in/out of image. Mostly used by PDF printer for access to "printed" files
- Communicates with Firebird DBMS server via docker-compose network (n6293_net) via FB standard port 3050
- HTML 5 GUI is accessed on host via `http://localhost:6080`. VNC client can also access same desktop via port `5900`.
- Software added for NURS6293:
  - DBSchema. CURL pulls version 9.1.0 (DBSURL in Dockerfile)
    - Replaces X64-specific javafx jars with AARCH64 jars in /opt/DbSchema/lib/
  - Jaybird 4.0.6 (JAYURL in Dockerfile)
  - FlameRobin
  - Libreoffice (BASE used for report writing class module)
  - CUPS/PDF-Printer -- configured to drop PDF files into $HOME/Desktop/Transfer_Station/PDF_Files directory for printing on host printer. 
  
 ## To build Docker image:
 - Make sure mgkahn/ubuntu_22_04:latest on DockerHub is up-to-date (https://hub.docker.com/repository/docker/mgkahn/ubuntu_22_04). This is used as the base multi-arch builder image.
   - To make unbuntu_22_04:latest:
     - Download `https://github.com/mgkahn/docker-ubuntu_22-04-novnc`
     - Checkout nurs6293 branch. Minor changes to upstream on this branch
     - use multi-arch version Makefile commands (added targets to upstream Makefile):
       - `make buildx` (uses cached layers)
       - `make buildx-from-scratch` (uses --no-cache)
 - To build nurs6293_ui local images for native architecture only :
   - `make build`
   - `make from-scratch`
 - To build nurs6293_ui multi-arch images for DockerHub:
   - Use master branch
   - `make buildx-push`
   
 ## To run:
 - Local image (not multiarch): `make run`
 - DockerHub image (multiarch): 
   - Mac: `startCompose8.sh` (uses embedded docker-compose.yml)
   - Windows: startup script under construction
 - If default browser does not open up by script:
   - start browser and point to `http://localhost:6080
 - If prefer to use VNC client: point client to Port 5900
 
 ## TO DOs:
 - Figure out how to insert Jaybird classpath into Libreoffice at run time rather than using existing hack (see Construction points for me to remember).
 - DONE: Figure out how to send SIGTERM generated by `KillSession` on UI container to DB container.
   - DONE: Can remove ugly --abort-on-container-exit hack (startCompose8.sh)
   - DONE: ui container sends SIGTERM to db container via docker.sock using killsession.py
 - Create host (Windows,Mac) desktop launchers so students do not need to execute a shell srcript in a CMD window (Windows) / terminal window (Mac)
   - DONE (Mac): Uses outstanding Platypus Mac launcher creation tool (https://github.com/sveinbjornt/Platypus)
 
 ## Construction points for me to remember:
 - Libreoffice does not create configuration folder/files prior to first run. I need configuration files in $HOME/.config/libreoffice before first run in order to insert classpath information for JAYBIRD. I provide a configuration folder that may get out of date as LO is updated. See TO DOs
 - GUI changes made by rootfs/etc/startup/desktop_changes.sh
 - cupsd configuration added in rootfs/etc/cups, rootfs/etc/cupshelpers, 
 - cupsd started by new entry in rootfs/etc/superviosor/conf.d/sueprvisord.conf
 - For SIGTERM signal from UI to DB:
   - need to mount /var/run/docker.sock (this could be a security concern)
   - Added new killsession_replace.sh script to startup folder.
   - Uses nc (apt-get install netstat) to send signal to DB container
   - Need to add permissions for `sudo nc` to /etc/sudoers.d (new file: /etc/sudoers.d/netcat)
 - GUI changes made in rootfs/etc/startup/desktop_changes.sh
   - changes to NOVNC defaults (resize, scaling defaults)
   - changes to desktop backgroun color
   - Desktop launcher icons
   - Desktop task bar launchers
   - FlameRobin databases
   - Libreoffice configurations
     - Add JAYBIRD jar to Libreoffice javasettings XML
     - Add Base database ODB file to desktop
 - chown everything in $HOME to $USERNAME:$USERNAME
 - UI_VOL mounted to ${HOME} to maintain UI state across sessions.
   - If UI weirdness or need UI reset: need to execute `docker volume rm ui_vol` in CMD (Windows) or Terminal (Mac) window. Running this command will delete any new Desktop files. Only files stored in Transfer_Station will be saved.


